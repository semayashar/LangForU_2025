<!DOCTYPE html>
<html class="no-js" lang="bg" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta content="ie=edge" http-equiv="x-ua-compatible">
    <title>LangForU | –†–µ–∑—É–ª—Ç–∞—Ç –æ—Ç —Ñ–∏–Ω–∞–ª–µ–Ω –∏–∑–ø–∏—Ç</title>
    <meta content="–†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç —Ñ–∏–Ω–∞–ª–µ–Ω –∏–∑–ø–∏—Ç –≤ LangForU." name="description">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <link href="/img/logo/logo.ico" rel="icon" type="image/x-icon">

    <!-- Stylesheets -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/owl.carousel.min.css" rel="stylesheet">
    <link href="/css/slicknav.css" rel="stylesheet">
    <link href="/css/animate.min.css" rel="stylesheet">
    <link href="/css/custom-images.css" rel="stylesheet">
    <link href="/css/hamburgers.min.css" rel="stylesheet">
    <link href="/css/magnific-popup.css" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css" rel="stylesheet">
    <link href="/css/themify-icons.css" rel="stylesheet">
    <link href="/css/slick.css" rel="stylesheet">
    <link href="/css/nice-select.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@latest/dist/confetti.browser.min.js"></script>
</head>

<body>
<!-- Preloader -->
<div id="preloader-active">
    <div class="preloader d-flex align-items-center justify-content-center">
        <div class="preloader-inner position-relative">
            <div class="preloader-circle"></div>
            <div class="preloader-img pere-text">
                <img alt="–ó–∞—Ä–µ–∂–¥–∞–Ω–µ..." src="/img/logo/loder_black.png">
            </div>
        </div>
    </div>
</div>

<!-- Navigation -->
<header th:replace="~{fragments/navigation}"></header>

<!-- Main Content -->
<main>
    <section class="sample-text-area">
        <div class="container box_1170">
            <h3 class="mb-30">–§–∏–Ω–∞–ª–µ–Ω –∏–∑–ø–∏—Ç - —Ä–µ–∑—É–ª—Ç–∞—Ç–∏</h3>

            <p>–ó–∞—Ç–≤–æ—Ä–µ–Ω–∏ –≤—ä–ø—Ä–æ—Å–∏: <strong th:text="${result.multipleChoiceScore} + '/15'"></strong></p>
            <p>–û—Ç–≤–æ—Ä–µ–Ω–∏ –≤—ä–ø—Ä–æ—Å–∏: <strong th:text="${result.openEndedScore} + '/30'"></strong></p>
            <p>–ï—Å–µ: <strong th:text="${result.essayScore} + '/30'"></strong></p>
            <hr>
            <p>–û–±—â–∞ –æ—Ü–µ–Ω–∫–∞: <strong th:text="${result.finalScore} + '/75'"></strong></p>

            <!-- –û—Ü–µ–Ω–∫–∞ -->
            <p><strong>–û—Ü–µ–Ω–∫–∞:</strong>
                <span class="text-success" th:if="${result.finalScore >= 70}">–û—Ç–ª–∏—á–µ–Ω (5.50 - 6.00) üéâ</span>
                <span class="text-primary" th:if="${result.finalScore >= 63 && result.finalScore < 70}">–ú–Ω. –¥–æ–±—ä—Ä (4.50 - 5.49) üëç</span>
                <span class="text-warning" th:if="${result.finalScore >= 54 && result.finalScore < 63}">–î–æ–±—ä—Ä (3.50 - 4.49) üôÇ</span>
                <span class="text-danger" th:if="${result.finalScore >= 45 && result.finalScore < 54}">–°—Ä–µ–¥–µ–Ω (3.00 - 3.49) üòï</span>
                <span class="text-dark" th:if="${result.finalScore < 45}">–°–ª–∞–± (–¥–æ 2.99) üòû</span>
            </p>

            <!-- –°—Ç–∞—Ç—É—Å -->
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
                <span class="text-success" th:if="${result.passed}">–ü—Ä–µ–º–∏–Ω–∞—Ç ‚úÖ</span>
                <span class="text-danger" th:unless="${result.passed}">–ù–µ—É—Å–ø–µ—à–µ–Ω ‚ùå</span>
            </p>

            <!-- –û–±—Ä–∞—Ç–Ω–∞ –≤—Ä—ä–∑–∫–∞ -->
            <div class="mt-4">
                <h5>–û–±—Ä–∞—Ç–Ω–∞ –≤—Ä—ä–∑–∫–∞ –ø–æ –µ—Å–µ—Ç–æ:</h5>
                <blockquote class="generic-blockquote" th:text="${essayFeedback}"></blockquote>
            </div>

            <!-- Certificate Download -->
            <div class="mt-4" th:if="${shouldDownload}">
                <button aria-label="–ò–∑—Ç–µ–≥–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç" class="btn btn-primary" id="downloadCertificateBtn">–ò–∑—Ç–µ–≥–ª–∏
                    —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
                </button>
            </div>
        </div>
    </section>
</main>

<!-- Footer -->
<footer th:replace="~{fragments/footer}"></footer>

<!-- Scroll to top -->
<div id="back-top">
    <a href="#" title="–û–±—Ä–∞—Ç–Ω–æ –≤ –Ω–∞—á–∞–ª–æ—Ç–æ"> <i class="fas fa-level-up-alt"></i></a>
</div>

<!-- Scripts -->
<script th:replace="~{fragments/script}"></script>

<!-- Confetti on pass + Certificate download logic -->
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {
        // –ü—Ä–∞–≤–∏–ª–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∏—Ç–µ –æ—Ç –º–æ–¥–µ–ª–∞ –Ω–∞ Thymeleaf
        const passed = /*[[${result.passed}]]*/ false;
        const examId = /*[[${result.finalExam.id}]]*/ 0;
        const shouldDownload = /*[[${shouldDownload}]]*/ false;

        // –ö–æ–Ω—Ñ–µ—Ç–∏ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–µ–º–∏–Ω–∞—Ç –∏–∑–ø–∏—Ç
        if (passed) {
            confetti({
                particleCount: 120,
                spread: 90,
                origin: { y: 0.6 }
            });
        }

        // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ event listener –∫—ä–º –±—É—Ç–æ–Ω–∞ –∑–∞ –∏–∑—Ç–µ–≥–ª—è–Ω–µ
        const downloadBtn = document.getElementById("downloadCertificateBtn");
        if (downloadBtn) {
            downloadBtn.addEventListener("click", () => {
                downloadCertificate(examId);
            });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑—Ç–µ–≥–ª—è–Ω–µ –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞
        if (shouldDownload) {
            downloadCertificate(examId);
        }
    });

    function downloadCertificate(examId) {
        fetch(`/final-exams/${examId}/certificate`, {
            method: "GET",
            headers: {
                "Accept": "application/pdf"
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–∞–≤–∞–Ω–µ—Ç–æ –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞.");
            }
            return response.blob();
        })
        .then(blob => {
            if (blob.size === 0) {
                throw new Error("–ü–æ–ª—É—á–µ–Ω–∏—è—Ç —Ñ–∞–π–ª –µ –ø—Ä–∞–∑–µ–Ω.");
            }
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = "certificate.pdf";
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
        })
        .catch(error => {
            console.error("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤–∞–ª—è–Ω–µ—Ç–æ –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:", error);
            alert("–ù–µ—É—Å–ø–µ—à–Ω–æ –∏–∑—Ç–µ–≥–ª—è–Ω–µ –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.");
        });
    }
</script>
</body>
</html>
